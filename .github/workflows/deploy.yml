name: Deploy to Production

on:
    push:
        branches: [main, master]
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        env:
            IMAGE_NAME: ourdecade_web_app:latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: |
                  echo "=== å¼€å§‹æ„å»º Docker é•œåƒ ==="
                  # å…³é”®ï¼šé€šè¿‡ --build-arg ä¼ é€’ç¯å¢ƒå˜é‡åˆ° Dockerfile
                  docker build \
                    --build-arg UMI_APP_COS_SECRET_BUCKET=${{ secrets.UMI_APP_COS_SECRET_BUCKET }} \
                    --build-arg UMI_APP_COS_SECRET_ID=${{ secrets.UMI_APP_COS_SECRET_ID }} \
                    --build-arg UMI_APP_COS_SECRET_KEY=${{ secrets.UMI_APP_COS_SECRET_KEY }} \
                    --build-arg UMI_APP_COS_SECRET_REGION=${{ secrets.UMI_APP_COS_SECRET_REGION }} \
                    -t $IMAGE_NAME .

                  echo "æ„å»ºåçš„é•œåƒåˆ—è¡¨ï¼š"
                  docker images | grep ourdecade_web_app

                  if [ $? -ne 0 ]; then
                    echo "âŒ é•œåƒæ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° ourdecade_web_app é•œåƒ"
                    exit 1
                  fi
                  echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"

            # ä»¥ä¸‹æ­¥éª¤ä¿æŒä¸å˜ï¼ˆSave and compress image / Upload / Deploy ç­‰ï¼‰
            - name: Save and compress image
              run: |
                  echo "=== ä¿å­˜å¹¶å‹ç¼©é•œåƒ ==="
                  docker save $IMAGE_NAME | gzip > image.tar.gz

                  echo "é•œåƒæ–‡ä»¶ä¿¡æ¯ï¼š"
                  ls -lh image.tar.gz
                  FILESIZE=$(stat -c%s "image.tar.gz")
                  echo "æ–‡ä»¶å¤§å°: $FILESIZE å­—èŠ‚"

                  if [ $FILESIZE -lt 1000 ]; then
                    echo "âŒ é”™è¯¯: é•œåƒæ–‡ä»¶å¤ªå°ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
                    exit 1
                  fi

                  if gzip -t image.tar.gz; then
                    echo "âœ… é•œåƒæ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
                  else
                    echo "âŒ é”™è¯¯: é•œåƒæ–‡ä»¶æŸå"
                    exit 1
                  fi

            - name: Debug - Local file check
              run: |
                  echo "=== æœ¬åœ°æ–‡ä»¶è°ƒè¯•ä¿¡æ¯ ==="
                  md5sum image.tar.gz
                  du -sh image.tar.gz

            - name: Upload image to server via SCP
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  port: ${{ secrets.DEPLOY_PORT || 22 }}
                  source: 'image.tar.gz'
                  target: '${{ secrets.PROJECT_PATH }}/'
                  debug: true

            - name: Deploy application on server
              uses: appleboy/ssh-action@v0.1.7
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  port: ${{ secrets.DEPLOY_PORT || 22 }}
                  debug: true
                  script: |
                      PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
                      set -eo pipefail
                      echo "=== å¼€å§‹éƒ¨ç½²æµç¨‹ ==="
                      echo "éƒ¨ç½²æ—¶é—´: $(date)"
                      echo "Git Commit SHA: ${{ github.sha }}"
                      echo "éƒ¨ç½²ç›®å½•: $PROJECT_PATH"

                      mkdir -p $PROJECT_PATH
                      cd $PROJECT_PATH
                      echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"

                      if [ ! -f image.tar.gz ]; then
                        echo "âŒ é”™è¯¯: é•œåƒæ–‡ä»¶æœªä¸Šä¼ æˆåŠŸ"
                        echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
                        ls -la
                        exit 1
                      fi

                      FILESIZE=$(stat -c%s "image.tar.gz")
                      echo "é•œåƒæ–‡ä»¶å¤§å°: $FILESIZE å­—èŠ‚"
                      md5sum image.tar.gz

                      if [ $FILESIZE -lt 1000 ]; then
                        echo "âŒ é”™è¯¯: é•œåƒæ–‡ä»¶å¤§å°å¼‚å¸¸ï¼ˆå°äº1KBï¼‰"
                        exit 1
                      fi

                      if ! gzip -t image.tar.gz; then
                        echo "âŒ é”™è¯¯: é•œåƒæ–‡ä»¶å‹ç¼©æŸå"
                        exit 1
                      fi
                      echo "âœ… é•œåƒæ–‡ä»¶éªŒè¯é€šè¿‡"

                      if [ -d .git ]; then
                        git pull origin main || git pull origin master
                      else
                        echo "âš ï¸  éGitä»“åº“ï¼Œè·³è¿‡ä»£ç æ‹‰å–"
                      fi

                      echo -e "\n=== 5. æ¸…ç†Dockerç¯å¢ƒ ==="
                      docker system prune -af --volumes 2>/dev/null || true

                      echo -e "\n=== 6. åŠ è½½Dockeré•œåƒ ==="
                      if gunzip -c image.tar.gz | docker load; then
                        echo "âœ… é•œåƒåŠ è½½æˆåŠŸ"
                        docker images | grep ourdecade_web_app
                      else
                        echo "âŒ é•œåƒåŠ è½½å¤±è´¥"
                        exit 1
                      fi

                      echo -e "\n=== 7. å¯åŠ¨æœåŠ¡ ==="
                      COMPOSE_CMD="docker compose"
                      if ! command -v $COMPOSE_CMD &> /dev/null; then
                        COMPOSE_CMD="docker-compose"
                      fi
                      echo "ä½¿ç”¨çš„Composeå‘½ä»¤: $COMPOSE_CMD"

                      $COMPOSE_CMD down 2>/dev/null || true
                      $COMPOSE_CMD up -d

                      echo -e "\n=== 8. éªŒè¯éƒ¨ç½²ç»“æœ ==="
                      sleep 8
                      $COMPOSE_CMD ps
                      echo -e "\nå®¹å™¨æ—¥å¿—ï¼ˆæœ€å10è¡Œï¼‰ï¼š"
                      $COMPOSE_CMD logs --tail=10 web

                      echo -e "\n=== 9. å¥åº·æ£€æŸ¥ ==="
                      if curl -f -m 10 http://localhost >/dev/null 2>&1; then
                        echo "âœ… HTTP æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
                      elif curl -f -m 10 https://localhost --insecure >/dev/null 2>&1; then
                        echo "âœ… HTTPS æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ï¼ˆå¿½ç•¥è¯ä¹¦ï¼‰"
                      else
                        echo "âš ï¸  æœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼Œä½†å®¹å™¨å·²å¯åŠ¨"
                        echo "å®¹å™¨çŠ¶æ€è¯¦æƒ…ï¼š"
                        docker inspect ourdecade_web_app --format '{{.State.Status}}'
                      fi

                      echo -e "\n=== 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
                      rm -f image.tar.gz

                      echo -e "\nğŸ‰ éƒ¨ç½²æµç¨‹å…¨éƒ¨å®Œæˆï¼"
